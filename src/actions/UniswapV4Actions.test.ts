import { expect, test } from "bun:test";
import { UniswapV4ActionsBuilder, type PoolKey } from "./UniswapV4Actions";
import { parseEther, zeroAddress } from "viem";
import { TickMath } from "../math/tickMath";

const MOCK_ADDRESS = "0x3Ebad585Af7A40f2ab97ceeB819f273Cbb3f71fB";
const poolKey: PoolKey = {
  currency0: zeroAddress,
  currency1: MOCK_ADDRESS,
  fee: 100,
  tickSpacing: 1,
  hooks: MOCK_ADDRESS,
};

test("swap", () => {
  const actions = UniswapV4ActionsBuilder.fromArray([
    {
      name: "swap",
      args: [
        poolKey,
        {
          zeroForOne: false,
          amountSpecified: -parseEther("0.2"),
          sqrtPriceLimitX96: TickMath.getSqrtRatioAtTick(3),
        },
        "0x",
      ],
    },
  ]);
  actions.finalizeSwap(
    poolKey.currency1,
    poolKey.currency0,
    MOCK_ADDRESS,
    false,
  );
  expect(actions.encode().toCalldata()).toBe(
    "0x0000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000030d0f0e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003ebad585af7a40f2ab97ceeb819f273cbb3f71fb000000000000000000000000000000000000000000000000000000000000006400000000000000000000000000000000000000000000000000000000000000010000000000000000000000003ebad585af7a40f2ab97ceeb819f273cbb3f71fb0000000000000000000000000000000000000000000000000000000000000000fffffffffffffffffffffffffffffffffffffffffffffffffd39750f44ec000000000000000000000000000000000000000000010009d4a533442b66e189a4ec0000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000003ebad585af7a40f2ab97ceeb819f273cbb3f71fb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003ebad585af7a40f2ab97ceeb819f273cbb3f71fb0000000000000000000000000000000000000000000000000000000000000000",
  );
});
