import { expect, test } from "bun:test";
import { parseEther, zeroAddress } from "viem";
import type { PoolKey } from "./UniswapV4Actions";
import { UniswapV4PositionManagerActionsBuilder } from "./UniswapV4PositionActions";

const MOCK_ADDRESS = "0x3Ebad585Af7A40f2ab97ceeB819f273Cbb3f71fB";
const poolKey: PoolKey = {
  currency0: zeroAddress,
  currency1: MOCK_ADDRESS,
  fee: 100,
  tickSpacing: 1,
  hooks: MOCK_ADDRESS,
};

test("initializeLiquidity", () => {
  const actions = UniswapV4PositionManagerActionsBuilder.fromArray([
    {
      name: "mintPosition",
      args: [
        poolKey,
        -2,
        2,
        parseEther("10000.5"),
        parseEther("1"),
        parseEther("1"),
        MOCK_ADDRESS,
        "0x",
      ],
    },
    {
      name: "settlePair",
      args: [poolKey.currency0, poolKey.currency1],
    },
  ]);

  actions.addAction({
    name: "sweep",
    args: [zeroAddress, MOCK_ADDRESS],
  });

  expect(actions.encode().toCalldata()).toBe(
    "0x000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000003020d140000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000028000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003ebad585af7a40f2ab97ceeb819f273cbb3f71fb000000000000000000000000000000000000000000000000000000000000006400000000000000000000000000000000000000000000000000000000000000010000000000000000000000003ebad585af7a40f2ab97ceeb819f273cbb3f71fbfffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000021e20d1251485f200000000000000000000000000000000000000000000000000000de0b6b3a76400000000000000000000000000000000000000000000000000000de0b6b3a76400000000000000000000000000003ebad585af7a40f2ab97ceeb819f273cbb3f71fb00000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003ebad585af7a40f2ab97ceeb819f273cbb3f71fb000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003ebad585af7a40f2ab97ceeb819f273cbb3f71fb",
  );
});
